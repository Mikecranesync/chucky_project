name: IssueOps - Deploy to Production

on:
  issues:
    types: [labeled]

permissions:
  contents: read
  issues: write

env:
  N8N_URL: ${{ secrets.N8N_URL }}
  N8N_API_KEY: ${{ secrets.N8N_API_KEY }}

jobs:
  deploy-production:
    name: Deploy to Production n8n
    if: github.event.label.name == 'deploy-to-prod'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ secrets.N8N_URL }}
    steps:
      - name: Add deployment started comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸš€ Production Deployment Started\n\n` +
                    `**Triggered by:** @${context.actor}\n` +
                    `**Workflow Run:** [View Progress](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n` +
                    `â³ Waiting for approval and deployment...`
            });

            // Add in-progress label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['status:in-progress']
            });

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Parse issue for workflow files
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body || '';
            const issueTitle = context.payload.issue.title || '';

            // Extract workflow files from issue body
            // Look for patterns like: workflow.json, Chucky.json, etc.
            const filePattern = /([A-Za-z0-9_\-]+(?:Workflow)?\.json)/g;
            const matches = [...issueBody.matchAll(filePattern)];

            let workflowFiles = matches.map(m => m[1]);

            // If no files found in body, check title
            if (workflowFiles.length === 0) {
              const titleMatches = [...issueTitle.matchAll(filePattern)];
              workflowFiles = titleMatches.map(m => m[1]);
            }

            // If still no files, look for checkbox-style lists
            const checkboxPattern = /- \[[ x]\] (.+\.json)/gi;
            const checkboxMatches = [...issueBody.matchAll(checkboxPattern)];
            if (checkboxMatches.length > 0) {
              workflowFiles = checkboxMatches.map(m => m[1].trim());
            }

            core.setOutput('workflow_files', workflowFiles.join(' '));
            core.setOutput('workflow_count', workflowFiles.length);

            return {
              files: workflowFiles,
              count: workflowFiles.length
            };

      - name: Validate workflow files exist
        id: validate
        run: |
          WORKFLOW_FILES="${{ steps.parse.outputs.workflow_files }}"

          if [ -z "$WORKFLOW_FILES" ]; then
            echo "::error::No workflow files specified in issue"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "## ðŸ“‹ Deployment Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflows to deploy:**" >> $GITHUB_STEP_SUMMARY

          MISSING_FILES=""
          VALID_FILES=""

          for file in $WORKFLOW_FILES; do
            if [ -f "$file" ]; then
              WORKFLOW_NAME=$(jq -r '.name // "Unnamed"' "$file" 2>/dev/null)
              echo "- âœ… $file ($WORKFLOW_NAME)" >> $GITHUB_STEP_SUMMARY
              VALID_FILES="$VALID_FILES $file"
            else
              echo "- âŒ $file (NOT FOUND)" >> $GITHUB_STEP_SUMMARY
              MISSING_FILES="$MISSING_FILES $file"
            fi
          done

          echo "valid_files=$VALID_FILES" >> $GITHUB_OUTPUT

          if [ -n "$MISSING_FILES" ]; then
            echo "::error::Some workflow files not found: $MISSING_FILES"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "valid=true" >> $GITHUB_OUTPUT

      - name: Comment on validation failure
        if: failure() && steps.validate.conclusion == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## âŒ Deployment Failed - Validation Error\n\n` +
                    `**Issue:** No valid workflow files found in this issue.\n\n` +
                    `### How to specify workflows:\n\n` +
                    `**Option 1:** List files in issue body:\n` +
                    `\`\`\`\n` +
                    `Deploy these workflows:\n` +
                    `- ChuckyDiscordRAG.json\n` +
                    `- Payment_Management_Workflow.json\n` +
                    `\`\`\`\n\n` +
                    `**Option 2:** Use checkboxes:\n` +
                    `\`\`\`\n` +
                    `- [ ] ChuckyDiscordRAG.json\n` +
                    `- [ ] Payment_Management_Workflow.json\n` +
                    `\`\`\`\n\n` +
                    `**Option 3:** Mention in title:\n` +
                    `\`Deploy ChuckyDiscordRAG.json to production\`\n\n` +
                    `After updating the issue, remove and re-add the \`deploy-to-prod\` label to retry.`
            });

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'deploy-to-prod'
            });

      - name: Deploy to production
        if: steps.validate.outputs.valid == 'true'
        id: deploy
        run: |
          if [ -z "$N8N_URL" ] || [ -z "$N8N_API_KEY" ]; then
            echo "::error::Production n8n credentials not configured"
            exit 1
          fi

          echo "## ðŸš€ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          SUCCESS_COUNT=0
          FAIL_COUNT=0
          DEPLOYMENT_LOG=""

          for file in ${{ steps.validate.outputs.valid_files }}; do
            echo "::group::Deploying $file to production"

            WORKFLOW_ID=$(jq -r '.id // empty' "$file" 2>/dev/null)
            WORKFLOW_NAME=$(jq -r '.name // "Unnamed"' "$file" 2>/dev/null)

            echo "Deploying: $WORKFLOW_NAME"

            if [ -z "$WORKFLOW_ID" ]; then
              METHOD="POST"
              URL="$N8N_URL/api/v1/workflows"
              ACTION="Created"
            else
              METHOD="PUT"
              URL="$N8N_URL/api/v1/workflows/$WORKFLOW_ID"
              ACTION="Updated"
            fi

            RESPONSE=$(curl -s -w "\n%{http_code}" \
              -X "$METHOD" \
              "$URL" \
              -H "X-N8N-API-KEY: $N8N_API_KEY" \
              -H "Content-Type: application/json" \
              -d @"$file" 2>&1)

            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')

            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "âœ… $ACTION $file successfully (HTTP $HTTP_CODE)"
              echo "- âœ… **$file** - $WORKFLOW_NAME ($ACTION)" >> $GITHUB_STEP_SUMMARY
              DEPLOYMENT_LOG="$DEPLOYMENT_LOG\n- âœ… $file - $WORKFLOW_NAME"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "::error file=$file::Deployment failed (HTTP $HTTP_CODE)"
              echo "- âŒ **$file** - Failed (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
              echo "Response: $BODY"
              DEPLOYMENT_LOG="$DEPLOYMENT_LOG\n- âŒ $file - Failed (HTTP $HTTP_CODE)"
              FAIL_COUNT=$((FAIL_COUNT + 1))
            fi

            echo "::endgroup::"
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:** $SUCCESS_COUNT succeeded, $FAIL_COUNT failed" >> $GITHUB_STEP_SUMMARY

          echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
          echo "fail_count=$FAIL_COUNT" >> $GITHUB_OUTPUT
          echo "deployment_log<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DEPLOYMENT_LOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ $FAIL_COUNT -gt 0 ]; then
            exit 1
          fi

      - name: Update issue on success
        if: success() && steps.deploy.conclusion == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const successCount = '${{ steps.deploy.outputs.success_count }}';
            const deploymentLog = `${{ steps.deploy.outputs.deployment_log }}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## âœ… Production Deployment Successful!\n\n` +
                    `**Deployed:** ${successCount} workflow(s)\n` +
                    `**Environment:** Production\n` +
                    `**URL:** ${{ secrets.N8N_URL }}\n\n` +
                    `### Deployment Results\n${deploymentLog}\n\n` +
                    `### Post-Deployment Checklist\n` +
                    `- [ ] Verify workflows are active in n8n\n` +
                    `- [ ] Test critical integrations (Discord, Telegram, etc.)\n` +
                    `- [ ] Monitor error logs for 24 hours\n` +
                    `- [ ] Update documentation if needed\n` +
                    `- [ ] Notify team of deployment\n\n` +
                    `**Deployed by:** @${context.actor} at ${new Date().toISOString()}`
            });

            // Add deployed label and remove in-progress
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['status:deployed']
            });

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'status:in-progress'
            }).catch(() => {});

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'deploy-to-prod'
            }).catch(() => {});

      - name: Update issue on failure
        if: failure() && steps.deploy.conclusion == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const failCount = '${{ steps.deploy.outputs.fail_count }}';
            const successCount = '${{ steps.deploy.outputs.success_count }}';
            const deploymentLog = `${{ steps.deploy.outputs.deployment_log }}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## âŒ Production Deployment Failed\n\n` +
                    `**Failed:** ${failCount} workflow(s)\n` +
                    `**Succeeded:** ${successCount} workflow(s)\n\n` +
                    `### Deployment Results\n${deploymentLog}\n\n` +
                    `### Troubleshooting\n` +
                    `- [ ] Check [workflow run logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n` +
                    `- [ ] Verify n8n instance is accessible: ${{ secrets.N8N_URL }}\n` +
                    `- [ ] Check API key validity\n` +
                    `- [ ] Validate workflow JSON syntax\n` +
                    `- [ ] Review n8n server logs\n\n` +
                    `**Action:** Remove and re-add the \`deploy-to-prod\` label to retry after fixing issues.`
            });

            // Add failed label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['status:failed', 'priority:high']
            });

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'status:in-progress'
            }).catch(() => {});

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'deploy-to-prod'
            }).catch(() => {});
